function setCookie(e,t,a){var l=a?"; domain="+a:"";document.cookie=e+"="+encodeURIComponent(t)+"; max-age=31536000; path=/"+l}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),l=0;l<a.length;l++){for(var i=a[l];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return decodeURIComponent(i.substring(t.length,i.length))}return null}function store(e,t){storage?localStorage.setItem(e,t):setCookie(e,t)}function restore(e){var t=null;return storage&&(t=localStorage.getItem(e))?t:getCookie(e)}function getBase64Image(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t.toDataURL("image/png")}var lang="en",globalship=null,globalbg=null,globalavatar=null,k2={},colle={},shipDB={},fleets=[new Array(6),new Array(6),new Array(6),new Array(6)],fleetLevels=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]],Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,a,l,i,n,s,o,r="",c=0;for(e=Base64._utf8_encode(e);c<e.length;)i=(t=e.charCodeAt(c++))>>2,n=(3&t)<<4|(a=e.charCodeAt(c++))>>4,s=(15&a)<<2|(l=e.charCodeAt(c++))>>6,o=63&l,isNaN(a)?s=o=64:isNaN(l)&&(o=64),r=r+Base64._keyStr.charAt(i)+Base64._keyStr.charAt(n)+Base64._keyStr.charAt(s)+Base64._keyStr.charAt(o);return r},decode:function(e){var t,a,l,i,n,s,o="",r=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");r<e.length;)t=Base64._keyStr.indexOf(e.charAt(r++))<<2|(i=Base64._keyStr.indexOf(e.charAt(r++)))>>4,a=(15&i)<<4|(n=Base64._keyStr.indexOf(e.charAt(r++)))>>2,l=(3&n)<<6|(s=Base64._keyStr.indexOf(e.charAt(r++))),o+=String.fromCharCode(t),64!=n&&(o+=String.fromCharCode(a)),64!=s&&(o+=String.fromCharCode(l));return o=Base64._utf8_decode(o)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",a=0;a<e.length;a++){var l=e.charCodeAt(a);l<128?t+=String.fromCharCode(l):l>127&&l<2048?(t+=String.fromCharCode(l>>6|192),t+=String.fromCharCode(63&l|128)):(t+=String.fromCharCode(l>>12|224),t+=String.fromCharCode(l>>6&63|128),t+=String.fromCharCode(63&l|128))}return t},_utf8_decode:function(e){for(var t="",a=0,l=c1=c2=0;a<e.length;)(l=e.charCodeAt(a))<128?(t+=String.fromCharCode(l),a++):l>191&&l<224?(c2=e.charCodeAt(a+1),t+=String.fromCharCode((31&l)<<6|63&c2),a+=2):(c2=e.charCodeAt(a+1),c3=e.charCodeAt(a+2),t+=String.fromCharCode((15&l)<<12|(63&c2)<<6|63&c3),a+=3);return t}},storage=function(){var e,t,a=new Date;try{return(e=window.localStorage).setItem(a,a),t=e.getItem(a)==a,e.removeItem(a),t&&e}catch(e){}}();$(document).ready(function(){$(".shipClass").each(function(){for(var e=$(this).find("input").length,t=new Array(e);e--;)t[e]=!1;k2[this.id]=t});var e={},t=0,a=0,l={},i={},n=0;$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db.json?v=13":"dbj.json?v=13"}).then(function(e){shipDB=e,$.ajax({dataType:"json",timeout:1e4,url:"conversion.json?v=13"}).then(function(e){l=e,T()},function(e){console.log("import db not found or invalid format, not performing import"),T()})},function(){$("#buttons").html("Can't find Kanmusu DB, please contact Vultren or Nya-chan on Github"),$("#tabs").remove()});var s={"016.png":{x:0,y:-140},"017.png":{x:0,y:-140},"021.png":{x:0,y:-140},"026.png":{x:0,y:-140},"037.png":{x:0,y:-140},"042a.png":{x:0,y:70},"042b.png":{x:0,y:70},"046.png":{x:0,y:-140},"057.png":{x:0,y:-140}},o=document.getElementById("result"),r=o.getContext("2d"),c=24,d=Math.sin(.523598776)*c,h=Math.cos(.523598776)*c,g=c+2*d,p=2*h,f=(5*g/4-p)/2,v=(5*g/4-g)/2+5,u="'Ubuntu', 'メイリオ', Times, serif",m="'Exo', 'メイリオ', Times, serif",b=function(e){c=e,d=Math.sin(.523598776)*c,h=Math.cos(.523598776)*c,f=(5*(g=c+2*d)/4-(p=2*h))/2,v=(5*g/4-g)/2+5},y=function(){var e=$(".furnitureClass input:checked").toArray(),t={};for(var a in e)t[e[a].name]=e[a].id;$(".shipClass").each(function(){var e=this.id,t={};$(this).find("input").each(function(e){t[this.id]=$(this).prop("checked")}),k2[e]=t}),store("ttkName",$("input[name='name']").val()),store("ttkLvl",$("input[name='level']").val()),store("ttkServer",$("select[name='server']").val()),store("ttkFurn",Base64.encode(JSON.stringify(t))),store("ttkFurnCam",$("#roomY").val()),store("ttkTint",$("#tint-color").val()),store("ttkHexOpa",$("#hexOpa").val()),store("k2",Base64.encode(JSON.stringify(k2))),store("secretaryCam",JSON.stringify([$("#customX").val(),$("#customY").val(),$("#customZ").val()])),store("secretaryHit",$(".damaged").size()>0&&!$($(".damaged")[0]).hasClass("abyss")),store("fleet",Base64.encode(fleets.join("|"))),store("fleetLvl",Base64.encode(fleetLevels.join("|"))),store("colle",Base64.encode(JSON.stringify(colle))),store("bg",globalbg),store("bgUse",$("#useBG").prop("checked")),store("bgCam",JSON.stringify([$("#bgX").val(),$("#bgY").val(),$("#bgZ").val()])),store("bgStretch",$("#bgStretch").prop("checked")),store("avatar",globalavatar)},k=function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$("input[name='name']").val(restore("ttkName")),$("input[name='level']").val(restore("ttkLvl"));var e=restore("bgCam");e=e?JSON.parse(e):[0,0,100],$("#bgX").val(e[0]),$("#bgY").val(e[1]),$("#bgZ").val(e[2]),$("#useBG").prop("checked",!restore("bgUse")||"true"==restore("bgUse"));var t=restore("secretaryCam");t=t?JSON.parse(t):[0,0,0],$("#customX").val(t[0]),$("#customY").val(t[1]),$("#customZ").val(t[2]),$("#roomY").val(restore("ttkFurnCam")||0),$("#tint-color").val(restore("ttkTint")||"#ffffff"),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#bgStretch").prop("checked",!restore("bgStretch")||"true"==restore("bgStretch")),"null"!=(globalbg=restore("bg"))&&$("#bg").attr("src",globalbg),"null"!=(globalavatar=restore("avatar"))?$("#avatar").attr("src",globalavatar):$("#avatar").removeAttr("src");var a=restore("ttkServer");"null"!=a&&$("select[name='server']").val(a);var l=restore("k2");l=l?JSON.parse(Base64.decode(l)):null;var i=restore("colle");i=i?JSON.parse(Base64.decode(i)):null;var s=restore("ttkFurn");s=s?JSON.parse(Base64.decode(s)):null;var o=restore("fleet");o=o?Base64.decode(o).split("|"):null;for(var r in o)o[r]=o[r].split(",");var c=restore("fleetLvl");c=c?Base64.decode(c).split("|"):null;for(var r in c)c[r]=c[r].split(",");if(l){k2=l,$(".shipClass input").prop("checked",!1);for(var r in k2)for(var d in k2[r])$("#"+d).prop("checked",k2[r][d])}if(i){colle=i,$("#colleDiv img").removeClass("selected");for(var r in colle)$("#kore"+r).addClass("selected")}if(o){fleets=o;for(var r in fleets[0]){var h=fleets[0][r];if(null!==h&&""!==h){0==r&&($("#"+h).addClass("flagship"),"true"==restore("secretaryHit")&&$("#"+h).next("span").addClass("damaged"),n=shipDB[h.substring(4)]?shipDB[h.substring(4)].rarity:0);p=parseInt(r)+1;$("#slot"+p).html('<img style="height:50px; width:50px;" src="'+$("#"+h).attr("src")+'"/>')}}}if(c){fleetLevels=c;for(var r in fleetLevels[0]){var g=parseInt(fleetLevels[0][r]);if(g&&g>0){var p=parseInt(r)+1;$("#level"+p).val(g)}}}if(s){var f=0;$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering...");var v=!1;for(var r in s){var u=s[r],m=$("#"+u);m.prop("checked",!0);var b=m.parent().parent().parent().attr("id"),y=$("#active"+b);if(y.off("load"),"Outside"==b){var k=$("#Outside").find(":checked"),C=$("#Window").find(":checked").attr("data-pType"),x="furniture/outside/"+(S=k.val()+C)+".png";y.attr("src",x)}else{var S=m.val();y.attr("src","furniture/"+b.toLowerCase()+"/"+S+".png")}y.prop("complete")?++f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?E(132):w("loadAllImgCached")):y.load(function(){++f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(v?"Couldn't find a furniture's image.":""),$("#displayRoom").hasClass("on")?E(132):w("loadAllImgLoaded"))}).error(function(e){v=!0,++f==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find a furniture's image."))})}}else w("loadNoFurniture")},C=function(){$(this).hasClass("abyss")||(fleets[t][a]=$(this).prev("img").attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).prev("img").attr("src")+'"/>')),0==t&&0==a&&($(this).hasClass("damaged")||$(".damaged").removeClass("damaged"),$(this).toggleClass("damaged"),$(".flagship").removeClass("flagship"),$(this).prev("img").toggleClass("flagship"),n=shipDB[$(this).prev("img").attr("id").substring(4)]?shipDB[$(this).prev("img").attr("id").substring(4)].rarity:0,w("fleetFlagshipChange"))},x=function(){$("#loadAbyss").remove(),$("#avatars .hidden").removeClass("hidden"),$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db2.json?v=13":"db2j.json?v=13",success:function(e){i=e,$("#loadingDiv").html("Loading images: "),$("#loadingProgress").show().html("0/"+Object.keys(e).length);var t=0;for(var a in i){var l=e[a];if(l.name){var s=$('<img class="abyss tooltip2" title="'+l.full+'" src="icons/'+l.type+"/"+a+'.png" id="icon'+a+'"></img>'),o=$('<span class="abyss" id="hit'+a+'">破</span>');s.on("load",function(){t++,$("#loadingProgress").html(t+"/"+Object.keys(e).length),t==Object.keys(e).length&&($("#loadingDiv").html(""),$("#loadingProgress").hide())}),s.on("click",function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=0,w("fleetShipChangeAbyss")}),0==$(".shipList [data-name='"+l.name+"']").length&&$(".div"+l.type).append("<div><label>"+l.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+l.name+'" class="'+l.type+'"></div></div>'),$("#avatars [data-name='"+l.name+"']").append(s),l.damageable&&$("#avatars [data-name='"+l.name+"']").append(o)}}$("#avatars span").unbind("click").on("click",C),$(".tooltip2").tooltipster()},error:function(){$("#loadingDiv").html("Can't find Abyssal DB, please contact Vultren or Nya-chan on Github")}})},w=function(e){if(console.log(e),$("#loadingDiv").html("Rendering..."),$("#buttons button").prop("disabled",!0),$("#save").prop("disabled",!0),r.clearRect(0,0,o.width,o.height),r.save(),r.fillStyle="#666",r.fillRect(0,0,o.width,o.height),$("#useBG").prop("checked"))E("displayBadge"!=$("#buttonToggles .active").attr("id")?132:parseInt(document.getElementById("roomY").value)),r.globalAlpha=.33,r.fillRect(0,0,o.width,o.height);else{var t=document.getElementById("bg"),a=$("#bgStretch").prop("checked"),l=$("#bgX").val()||0,i=$("#bgY").val()||0,n=$("#bgZ").val()||0;r.drawImage(t,l,i,a?o.width:t.width*(n/100),a?o.height:t.height*(n/100))}r.restore(),r.strokeRect(0,0,o.width,o.height),A()},S=function(e,t){var a=$("#avatar"),l=$(".flagship")[0]?$(".flagship")[0].id.substring(4):null,s=!1;l&&$("#hit"+l).hasClass("damaged")&&(s=!0);var c=$(".flagship").parent().length>0?$(".flagship").parent().attr("class"):null;if(null!=globalship)(d=new Image).onload=function(){var a=0,l=0;a+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,l+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var i=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;i/=100,r.translate(o.width-7*d.width/8+a,o.height/2-d.height/5+l),r.translate(d.width/2,d.height/2),r.scale(i,i),r.drawImage(d,-d.width/2,-d.height/2),r.restore(),e(),t||B(r)},d.onerror=e,d.src=globalship;else if(l){var d=new Image;d.onload=function(){var c=0,h=0;0==n&&i[l]?s&&i[l].offset2?(c=i[l].offset2.x,h=i[l].offset2.y):(c=i[l].offset.x,h=i[l].offset.y):shipDB[l]&&(s&&shipDB[l].offset2?(c=shipDB[l].offset2.x,h=shipDB[l].offset2.y):shipDB[l].offset&&(c=shipDB[l].offset.x,h=shipDB[l].offset.y)),c+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,h+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var g=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;g>=50&&g<=150?(g/=100,r.translate(o.width-7*d.width/8+c,o.height/2-d.height/5+h),r.translate(d.width/2,d.height/2),r.scale(g,g),r.drawImage(d,-d.width/2,-d.height/2)):r.drawImage(d,o.width-7*d.width/8+c,o.height/2-d.height/5+h),r.restore(),e(),t||(a.attr("src")?B(r):I(r,l,n))},d.onerror=e,d.src="full/"+c+"/"+l+(s?"x":"")+".png"}else e(),a.attr("src")&&!t&&B(r)},I=function(e,t,a){var a=document.getElementById("r"+a),l=document.getElementById("icon"+t);e.save(),e.fillStyle="black",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(a,30,5,100,100,35,45,100,100),e.drawImage(l,35,45)},B=function(e){var t=document.getElementById("avatar");e.save(),e.fillStyle="transparent",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(t,35,45,100,100)},A=function(){var e=$("#buttonToggles .active").attr("id");"displayBadge"==e?S($("#k2").prop("checked")?F:R):"displayPoster"==e?S(D,!0):"displayRoom"==e&&E(132)},D=function(){b(10),r.save();var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=($("#useBlue").prop("checked"),10*(2*Math.sin(Math.PI/2)+1)),i=o.height-10,n=40+h,s=55+h;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?O(e.value,20,25,3):O("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var c=new Date;O(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+u,r.textAlign="right",O("en"==lang?"DE":"海",40,56);var d=0,g=$("#colleDiv .divDE img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDE img").each(function(e){var t=55+d*p,a=Math.floor(d/40)*+l/2+55-15,i=document.getElementById(this.id);L(i,t,a,$(this).hasClass("selected"),!1),d++}),r.textAlign="left",r.font="14px "+m,O(g+"/"+d+" ("+(g/d*100).toFixed()+"%)",55+d*p+8,55),r.restore();var f=55+l/2+l/4;r.font="14px "+u,r.textAlign="right",O("en"==lang?"DD":"駆",n,f+10-9);var v=0,y=$("#colleDiv .divDD img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDD img").each(function(e){var t=s+v%40*p;Math.floor(v/40%2)>0&&(t=s+(40-v%40)*p-h);var a=Math.floor(v/40)*+l/2+f-15,i=document.getElementById(this.id);L(i,t,a,$(this).hasClass("selected"),!1),v++}),r.textAlign="left",r.font="14px "+m,O(y+"/"+v+" ("+(y/v*100).toFixed()+"%)",s+40*p+8,f),r.restore();var k=f+l+l/4+8*Math.floor(v/40),C=k+l/2+l/4,x=C+l/2+l/4,w=x+l/2+l/4,S=w+l/2+l/4,I=S+l/2+l/4,B=I+l/2+l/4;O("en"==lang?"CL":"軽巡",40,k+10-9);var A=0,D=$("#colleDiv .divCL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCL img").each(function(){var e=55+A*p,t=k-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),A++}),r.textAlign="left",r.font="14px "+m,O(D+"/"+A+" ("+(D/A*100).toFixed()+"%)",55+A*p+8,k),r.restore(),O("en"==lang?"CA":"重巡",n,C+10-9);var E=0,F=$("#colleDiv .divCA img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCA img").each(function(){var e=s+E*p,t=C-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),E++}),r.textAlign="left",r.font="14px "+m,O(F+"/"+E+" ("+(F/E*100).toFixed()+"%)",55+E*p+8,C),r.restore(),O("en"==lang?"CVL":"軽母",n,w+10-9);var R=0,j=$("#colleDiv .divCVL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCVL img").each(function(){var e=s+R*p,t=w-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),R++}),r.textAlign="left",r.font="14px "+m,O(j+"/"+R+" ("+(j/R*100).toFixed()+"%)",s+R*p+8,w),r.restore(),O("en"==lang?"BB":"戦",40,x+10-9);var T=0,N=$("#colleDiv .divBB img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divBB img").each(function(){var e=55+T*p,t=x-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),T++}),r.textAlign="left",r.font="14px "+m,O(N+"/"+T+" ("+(N/T*100).toFixed()+"%)",55+T*p+8,x),r.restore(),O("en"==lang?"CV":"航",40,S+10-9);var _=0,M=$("#colleDiv .divCV img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCV img").each(function(){var e=55+_*p,t=S-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),_++}),r.textAlign="left",r.font="14px "+m,O(M+"/"+_+" ("+(M/_*100).toFixed()+"%)",55+_*p+8,S),r.restore(),O("en"==lang?"SS":"潜",n,I+10-9);var W=0,Y=$("#colleDiv .divSS img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divSS img").each(function(){var e=s+W*p,t=I-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),W++}),r.textAlign="left",r.font="14px "+m,O(Y+"/"+W+" ("+(Y/W*100).toFixed()+"%)",s+W*p+8,I),r.restore(),O("en"==lang?"AX":"他",40,B+10-9);var P=0,U=$("#colleDiv .divAX img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divAX img").each(function(){var e=55+P*p,t=B-15,a=document.getElementById(this.id);L(a,e,t,$(this).hasClass("selected"),!1),P++}),r.textAlign="left",r.font="14px "+m,O(U+"/"+P+" ("+(U/P*100).toFixed()+"%)",55+P*p+8,B),r.restore(),r.font="12px "+u;var H=$("#colleDiv"),X=H.find("img.selected").length,J=H.find("img").length,V=X+"/"+J,Z=X/J;r.save(),r.strokeRect(540,i-10,300,8);var G=r.createLinearGradient(540,0,840,0);G.addColorStop(0,"#A00000"),G.addColorStop(.33,"#FF9900"),G.addColorStop(.66,"#DDDD33"),G.addColorStop(1,"#00A000"),r.fillStyle=G,r.fillRect(540,i-10,(300*Z).toFixed(),8),r.restore(),r.font="20px "+m,O(V+" ("+(100*Z).toFixed()+"%)",840,i-l/2,3),r.font="12px "+u,r.textAlign="right",O("Lv. "+(t.value?t.value:"?"),o.width/2,25),"Your Server"!=a?O(a.substring(a.indexOf(" ")+1),o.width-25,25):O("en"==lang?"Unknown Server":"不明サーバ",o.width-25,25),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},E=function(e){var t=o.width/bg.clientWidth,a=document.getElementById("activeFloor"),l=document.getElementById("activeWall"),i=document.getElementById("activeDesk"),n=document.getElementById("activeOutside"),c=document.getElementById("activeWindow"),d=document.getElementById("activeObject"),h=document.getElementById("activeChest");r.globalAlpha=1,t=o.width/a.clientWidth,a.complete&&r.drawImage(a,0,150*t+e,o.width,a.clientHeight*t),l.complete&&r.drawImage(l,0,-125*t+e,o.width,l.clientHeight*t),d.complete&&r.drawImage(d,0,-125*t+e,d.clientWidth*t,d.clientHeight*t),n.complete&&r.drawImage(n,210,-125*t+e,n.clientWidth*t,n.clientHeight*t),c.complete&&r.drawImage(c,210,-125*t+e,c.clientWidth*t,c.clientHeight*t);var g=i.src.match(/(\d\d\d.?).png$/gm),p=null;g&&(p=s[g[0]]),p?r.drawImage(i,p.x,p.y+e+7,i.clientWidth*t,i.clientHeight*t):r.drawImage(i,0,e+7,i.clientWidth*t,i.clientHeight*t),r.drawImage(h,o.width-h.clientWidth*t,-125*t+e,h.clientWidth*t,h.clientHeight*t);var f=$("#tint-color").val();r.fillStyle=f||"#ffffff",$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},O=function(e,t,a,l){r.save(),r.lineWidth=void 0!==l?l:2,r.strokeText(e,t,a),r.fillText(e,t,a),r.restore()},L=function(e,t,a,l,i){r.save(),r.beginPath(),r.moveTo(t+h,a),r.lineTo(t+p,a+d),r.lineTo(t+p,a+d+c),r.lineTo(t+h,a+g),r.lineTo(t,a+c+d),r.lineTo(t,a+d),r.closePath(),r.stroke(),r.fillStyle=i||"white",r.globalAlpha=$("#hexOpa").val()?$("#hexOpa").val():0,r.fill(),r.globalAlpha=1,r.clip(),e&&l&&r.drawImage(e,t-f,a-v,5*g/4,5*g/4),r.restore()},F=function(){b(22),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=45+1.5*c+8,i=l+1.5*c+8,n=i+1.5*c+8,s=210+h,d=225+h,g=s+h,f=d+h,v=g+h,m=f+h;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?O(e.value,20,25,3):O("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="darker",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var y=new Date;O(y.getFullYear()+"-"+(y.getMonth()+1)+"-"+y.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+u,r.textAlign="right",r.drawImage(document.getElementById("fleet1a"),187,45+c/2-15),r.drawImage(document.getElementById("fleet2a"),s-23,l+c/2-15),r.drawImage(document.getElementById("fleet3a"),g-23,i+c/2-15),r.drawImage(document.getElementById("fleet4a"),v-23,n+c/2-15),r.save(),r.fillStyle="white";for(var k=0;k<6;k++){var C=225+k*p,x=30,w=document.getElementById(fleets[0][k]),S=fleetLevels[0][k];L(w,C,x,!0),w&&(r.font="10px "+u,r.textAlign="left",O(S,C,x+8));var C=d+k*p,x=l-15,w=document.getElementById(fleets[1][k]),S=fleetLevels[1][k];L(w,C,x,!0),w&&(r.font="10px "+u,r.textAlign="left",O(S,C,x+8));var C=f+k*p,x=i-15,w=document.getElementById(fleets[2][k]),S=fleetLevels[2][k];L(w,C,x,!0),w&&(r.font="10px "+u,r.textAlign="left",O(S,C,x+8));var C=m+k*p,x=n-15,w=document.getElementById(fleets[3][k]),S=fleetLevels[3][k];L(w,C,x,!0),w&&(r.font="10px "+u,r.textAlign="left",O(S,C,x+8))}r.restore(),r.font="12px "+u,r.textAlign="center",O("Lv. "+(t.value?t.value:"?"),85,n-1),"Your Server"!=a?O(a.substring(a.indexOf(" ")+1),85,n+14):O("en"==lang?"Unknown Server":"不明サーバ",85,n+14),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#buttons button").prop("disabled",!1)},R=function(){b(16),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=$("#useBlue").prop("checked"),i=16*(2*Math.sin(Math.PI/2)+1),n=55+i,s=n+i,c=175+h,d=190+h;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?O(e.value,20,25,3):O("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var g=new Date;O(g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+u,r.textAlign="right",O("en"==lang?"DD":"駆",175,62);var f=0,v=$("#dd").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#dd").find("[type='checkbox']").each(function(e){var t=$(this).parent().parent();if(l&&t.hasClass("blueprint")&&!t.hasClass("kai"))this.checked&&t.hasClass("blueprint")&&y++;else{var a=190+f%12*p;Math.floor(f/12%2)>0&&(a=190+(12-f%12)*p-h);var n=Math.floor(f/12)*-i/2+55-15,s=document.getElementById("icon"+this.id),o=t.hasClass("blueprint")?"lightblue":"white";L(s,a,n,this.checked,o),f++}}),r.textAlign="left",r.font="14px "+m,O(v-y+"/"+f,190+12*p+8,62),r.restore(),O("en"==lang?"CL":"軽巡",c,55+i/2+16-9);var k=0,C=$("#cl").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#cl").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=d+k*p,a=40+i/2,n=document.getElementById("icon"+this.id),s=e.hasClass("blueprint")?"lightblue":"white";L(n,t,a,this.checked,s),k++}}),r.textAlign="left",r.font="14px "+m,O(C-y+"/"+k,d+k*p+8,62+i/2),r.restore(),O("en"==lang?"CA":"重巡",175,n+16-9);var x=0,w=$("#ca").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#ca").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=190+x*p,a=n-15,i=document.getElementById("icon"+this.id),s=e.hasClass("blueprint")?"lightblue":"white";L(i,t,a,this.checked,s),x++}}),r.textAlign="left",r.font="14px "+m,O(w-y+"/"+x,190+x*p+8,n+16-9),r.restore(),O("en"==lang?"CVL":"軽母",175,s+16-9);var S=0,I=$("#cvl").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#cvl").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=190+S*p,a=s-15,i=document.getElementById("icon"+this.id),n=e.hasClass("blueprint")?e.hasClass("prototype")?"pink":"lightblue":"white";L(i,t,a,this.checked,n),S++}}),r.textAlign="left",r.font="14px "+m,O(I-y+"/"+S,190+S*p+8,s+16-9),r.restore(),O("en"==lang?"BB":"戦",c,n+i/2+16-9);var B=0,A=$("#bb").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#bb").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=d+B*p,a=n-15+i/2,s=document.getElementById("icon"+this.id),o=e.hasClass("blueprint")?"lightblue":"white";L(s,t,a,this.checked,o),B++}}),r.textAlign="left",r.font="14px "+m,O(A-y+"/"+B,d+B*p+8,n+16-9+i/2),r.restore(),O("en"==lang?"CV":"航",c,s+i/2+16-9);var D=0,E=$("#cv").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#cv").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=d+D*p,a=s-15+i/2,n=document.getElementById("icon"+this.id),o=e.hasClass("blueprint")?e.hasClass("prototype")?"pink":"lightblue":"white";L(n,t,a,this.checked,o),D++}}),r.textAlign="left",r.font="14px "+m,O(E-y+"/"+D,d+D*p+8,s+16-9+i/2),r.restore();var F=(D+3)*p;O("en"==lang?"SS":"潜",c+F,s+i/2+16-9);var R=0,j=$("#ss").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#ss").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=F+d+R*p,a=s-15+i/2,n=document.getElementById("icon"+this.id),o=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";L(n,t,a,this.checked,o),R++}}),r.textAlign="left",r.font="14px "+m,O(j-y+"/"+R,F+d+R*p+8,s+16-9+i/2),r.restore();var T=(S+3)*p;O("en"==lang?"AX":"その他",175+T,s+16-9);var N=0,_=$("#ax").find("[type='checkbox']:checked").length,y=0;r.save(),r.fillStyle="white",$("#ax").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&y++;else{var t=T+190+N*p,a=s-15,i=document.getElementById("icon"+this.id),n=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";L(i,t,a,this.checked,n),N++}}),r.textAlign="left",r.font="14px "+m,O(_-y+"/"+N,T+190+N*p+8,s+16-9),r.restore(),r.font="12px "+u;var M=$(".shipOptions"),W=M.find(".blueprint").length-M.find(".kai").length,Y=M.find(".blueprint :checked").length-M.find(".kai :checked").length,P=l?M.find("[type='checkbox']:checked").length-Y:M.find("[type='checkbox']:checked").length,U=l?M.find("[type='checkbox']").length-W:M.find("[type='checkbox']").length,H=P+"/"+U,X=P/U;r.save(),r.strokeRect(540,o.height-20,300,8);var J=r.createLinearGradient(540,0,840,0);J.addColorStop(0,"#A00000"),J.addColorStop(.33,"#FF9900"),J.addColorStop(.66,"#DDDD33"),J.addColorStop(1,"#00A000"),r.fillStyle=J,r.fillRect(540,o.height-20,(300*X).toFixed(),8),r.restore(),r.font="20px "+m,O(H+" ("+(100*X).toFixed()+"%)",840,o.height-20,3),r.font="12px "+u,r.textAlign="center",O("Lv. "+(t.value?t.value:"?"),85,167),"------"!==a?O("en"==lang?a.substring(a.indexOf(" ")+1):a,85,182):O("en"==lang?"Unknown Server":"不明サーバ",85,182),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},j=function(){for(var e in colle)$("#kore"+e).addClass("selected");$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged");for(var e in fleets[0]){var t=fleets[0][e],a=t.substring(4);if(null!==t&&""!==t){0==e&&($("#"+t).addClass("flagship"),n=shipDB[a]?shipDB[a].rarity:0);i=parseInt(e)+1;$("#slot"+i).html('<img style="height:50px; width:50px;" src="icons/'+shipDB[a].type+"/"+a+'.png"/>')}}for(var e in fleetLevels[0]){var l=parseInt(fleetLevels[0][e]);if(l&&l>0){var i=parseInt(e)+1;$("#level"+i).val(l)}}w("initial")},T=function(){var i=$.extend({},l.mstId2FleetIdTable,l.mstId2KainiTable);if(apiMode){if(importName&&$("input[name='name']").val(importName),importLvl&&$("input[name='level']").val(importLvl),importServer&&$("select[name='server']").val(importServer),importShips){importShips=JSON.parse(importShips);var s={},c={};for(var d in importShips)if(importShips[d]in i&&(s[m=i[importShips[d]]]=!0,m in l.implicationTable))for(var h in l.implicationTable[m])s[l.implicationTable[m][h]]=!0;if(importK2){for(var d in s)if((m=$("#"+d)).length>0){var g=shipDB[d].type;c[g]||(c[g]={}),c[g][d]=!0,$("#"+d).prop("checked",!0)}k2=c}importColle&&(colle=s)}if(importFleets){importFleets=JSON.parse(importFleets);var p=[new Array(6),new Array(6),new Array(6),new Array(6)],f=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]];for(var v in importFleets)for(var d in importFleets[v])importFleets[v][d]&&null!=importFleets[v][d]&&i[importFleets[v][d].id]&&(p[v][d]="icon"+i[importFleets[v][d].id],f[v][d]=importFleets[v][d].lvl);fleets=p,fleetLevels=f}}r.strokeRect(0,0,o.width,o.height),r.imageSmoothingEnabled=!0,r.mozImageSmoothingEnabled=!0,r.webkitImageSmoothingEnabled=!0;d=0;for(var u in shipDB){var m=shipDB[u];if(m.name){var b=$('<img class="tooltip" title="'+m.full+'" src="icons/'+m.type+"/"+u+'.png" id="icon'+u+'"></img>'),S=$('<span id="hit'+u+'">破</span>');b.on("load",function(){d++,$("#loadingProgress").html(d+"/"+Object.keys(shipDB).length),d==Object.keys(shipDB).length&&j()}),0==$(".shipList [data-name='"+m.name+"']").length&&$(".div"+m.type).append("<div><label>"+m.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+m.name+'" class="'+m.type+'"></div></div>'),m.unique&&$("#colleDiv [data-name='"+m.name+"']").append('<img title="'+m.full+'"alt="full/FinalBoss.png" src="icons/'+m.type+"/"+u+'.png" id="kore'+u+'"></img>').append(S),$("#avatars [data-name='"+m.name+"']").append(b).append(S)}}$("#colleDiv .shipClasses").each(function(e){var t=$("<div class='colleAll'><input id='selectAll-"+e+"' type='checkbox'/><label for='selectAll-"+e+"'>"+("jp"==lang?"全て選択":"cn"==lang||"tw"==lang?"全選":"Select All")+"</label></div>");$(this).append(t),t.find("input").change(function(){var e=$(this).parent().parent().find("img");for(var t in e.toArray()){var a=$(e[t]);colle[a.attr("id").substring(4)]=this.checked,a.toggleClass("selected",this.checked)}w("colleChangeAll")})}),$(".tooltip").tooltipster(),$(".shipClasses").find("label").next("div").each(function(){0==$(this).find("img").length&&$(this).parent().remove()}),$("#fleetSelect div").click(function(){$("#fleetSelect .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(5);t=parseInt(e)-1,$("#fleets div").html(""),$("#fleetLevels input").val(1);for(var a in fleets[t]){var l=fleets[t][a],i=parseInt(a)+1;null!==l&&""!==l&&$("#slot"+i).html('<img style="height:50px; width:50px;" src="'+$("#"+l).attr("src")+'"/>'),$("#level"+i).val(fleetLevels[t][a])}}),$("#fleets div").click(function(){$("#fleets .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(4);a=parseInt(e)-1}),$("#fleetLevels input").change(function(){var e=this.id.substring(5);a=parseInt(e)-1,fleetLevels[t][a]=this.value,w("fleetLevelChange")}),$("#avatars img").on("click",function(){$(this).hasClass("abyss")||(fleets[t][a]=$(this).attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).attr("src")+'"/>')),0==t&&0==a&&($(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=shipDB[this.id.substring(4)]?shipDB[this.id.substring(4)].rarity:0),w("fleetShipChange")}),$("#colleDiv img").on("click",function(){colle[$(this).attr("id").substring(4)]&&$(this).hasClass("selected")?delete colle[$(this).attr("id").substring(4)]:$(this).hasClass("selected")||(colle[$(this).attr("id").substring(4)]=!0),$(this).toggleClass("selected"),w("colleChange")}),$("#avatars span").on("click",C),$(".shipList > label").click(function(){$(this).next("div").slideToggle()}),$(".shipClasses label").click(function(){$(this).next("div").toggle()}),$("#removeSlot").click(function(){0==t&&0==a&&($(".damaged").removeClass("damaged"),$(".flagship").removeClass("flagship"),n=0),fleets[t][a]=null,$("#fleets .chosen").html(""),w("fleetRemoveSlot")}),$(".shipOptions input[type='checkbox']").change(function(){w("kainiShipChange")}),$("#selectAll").on("change",function(){this.checked?$(".shipOptions [type='checkbox']").prop("checked",!0):$(".shipOptions [type='checkbox']").prop("checked",!1),w("kainiSelectAll")}),$("#displayBadge").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=240,w("displayBadge")}),$("#displayRoom").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,E(132)}),$("#displayPoster").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,w("displayPoster")}),$("#generate").on("click",w),$("#Floor,#Wall,#Desk,#Object,#Chest,#Window").on("change",function(){var t=this.id;delete e[t];var a=$("#active"+t),l=$(this).find(":checked").val();a.off("load"),a.attr("src","furniture/"+this.id.toLowerCase()+"/"+l+".png"),a.prop("complete")?$.isEmptyObject(e)&&"Window"!=t&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?E(132):w("furnitureChangeCache")):(e[t]=l,$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering..."),a.load(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?E(132):w("furnitureChangeLoaded"))}).error(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find this furniture's image."))})),"Window"==t&&$("#Outside").change()}),$("#Outside").on("change",function(t){delete e.Outside;var a=$("#activeOutside"),l=$("#Outside").find(":checked"),i=$("#Window").find(":checked").attr("data-pType"),n="furniture/outside/"+(l.val()+i)+".png";a.off("load"),a.attr("src",n),a.prop("complete")&&$.isEmptyObject(e)?($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?E(132):w("furnitureOutsideCache")):a.load(function(){delete e.Outside,$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?E(132):w("furnitureOutsideLoaded"))})}),$("#ttkInfo input[type='text'],#ttkInfo input[type='number']").blur(function(){w("ttkInfo")}),$("#ttkInfo select").click(function(){w("ttkServer")}),$("#ttkInfo input[type='checkbox']").click(function(){w("ttkLevel")}),$("#loadAbyss").click(function(){x()}),$("#save").on("click",function(){y(),this.setAttribute("disabled","disabled")}),$("#load").on("click",function(){k()}),$("#export").on("click",function(){alert("Right-click the image that opens up in a new tab and save it as PNG.");var e=o.toDataURL("image/png");window.open(e,"_blank")}),$("#avatar").load(function(){$.isEmptyObject(e)&&w("avatarImgChange")}),$("#bg").load(function(){$.isEmptyObject(e)&&w("bgImgChange")}),$("#customInputs input[type='checkbox']").change(function(){w("customInputChange")}),$("#customInputs input[type='number']").change(function(){w("customInputChange")}),$("#avatarImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#avatar").attr("src",e.target.result),globalavatar=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#customShip").attr("src",e.target.result),globalship=e.target.result,w("customShipChange")},e.readAsDataURL(this.files[0])}}),$("#bgImg").change(function(){if($("#useBG").prop("checked",!1),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#bg").attr("src",e.target.result),globalbg=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipClear").click(function(){globalship=null,$("#shipImg").val(""),$("#customShip").removeAttr("src"),w("clear")}),$("#avatarClear").click(function(){globalavatar=null,$("#avatarImg").val(""),$("#avatar").removeAttr("src"),w("clear")}),$("#bgClear").click(function(){globalbg=null,$("#bgImg").val(""),$("#bg").attr("src","bg.jpg"),w("clear")})}}),$(window).load(function(){$("#tabs").liteTabs({width:"100%"}),$("#tabs").show(),$(".furnitureClass.invert > div div").each(function(){$(this).prependTo(this.parentNode)})});